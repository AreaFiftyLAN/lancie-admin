<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/lancie-ajax/lancie-ajax.html">

<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../lancie-admin-endpoint/lancie-admin-page-layout.html">

<dom-module id="lancie-admin-rfid-consumption">
  <template>
    <style>
      :host {
        display: block;
      }

      .result {
        width: 200px;
        height: 200px;
        border-radius: 25px;
        box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        transition: background-color 0.5s ease;
      }

      .red {
        background-color: #F44336;
      }

      .blue {
        background-color: #2196F3;
      }

      .green {
        background-color: #4CAF50;
      }
    </style>

    <lancie-ajax
      id="ticketIdAjax"
      refurl="rfid/[[rfid]]/ticketId"
      on-lancie-ajax="onTicketId"
    ></lancie-ajax>

    <lancie-ajax
      id="consumeAjax"
      refurl="consumptions/[[ticketId]]/consume"
      method="post"
      body="[[selectedConsumptionId]]"
      on-lancie-ajax="onConsume"
    ></lancie-ajax>

    <lancie-ajax
      auto
      id="consumptionsAjax"
      refurl="consumptions"
      on-lancie-ajax="onConsumptions">
    </lancie-ajax>

    <lancie-admin-page-layout endpoint="Consumptions">
      <p>Laat users consumpties consumeren door de juiste consumptie te selecteren en zijn RFID bandje te scannen.</p>
      <paper-input autofocus id="rfid" value="{{rfid}}" on-keyDown="_requestUser"></paper-input>
      <paper-dropdown-menu label="consumptions">
        <paper-listbox class="dropdown-content" selected="{{selectedConsumptionId}}" attr-for-selected="data-id">
          <template is="dom-repeat" items='[[consumptions]]' as="consumption">
            <paper-item data-id="[[consumption.id]]">[[consumption.name]]</paper-item>
          </template>
        </paper-listbox>
      </paper-dropdown-menu>
      <div class$="result {{color}}"></div>
    </lancie-admin-page-layout>
  </template>
  <script>
    'use strict';

    (function () {
      Polymer({
        is: 'lancie-admin-rfid-consumption',
        properties: {
          ticketId: String,
          rfid: String,

          consumptions: {
            type: Array,
            value: [],
          },

          consumptionSuccessful: {
            type: Boolean,
            value: false,
          },
          displayColor: {
            type: Boolean,
            value: false,
          },
          color: {
            type: String,
            value: 'blue',
          },
        },

        observers: [
          'computeColor(hasTicket, displayColor)',
        ],

        _requestUser: function (e) {
          if (e.keyCode === 13) {
            this.$.ticketIdAjax.generateRequest();
            this.rfid = '';
          }
        },

        onTicketId: function (e, request) {
          if (request.succeeded) {
            this.ticketId = request.response;
            this.$.consumeAjax.
            this.$.consumeAjax.generateRequest();
          } else {
            this.fire('toast', {text: 'Could not retrieve ticket.'});
          }
        },

        onConsumptions: function (e, request) {
          if (request.succeeded) {
            this.consumptions = request.response;
          } else {
            this.fire('toast', {text: 'Could not retrieve consumptions.'});
          }
        },

        onConsume: function (e, request) {
          if (request.succeeded) {
              this.consumptionSuccessful = true;
          } else {

          }
        },

        computeColor: function (hasTicket, displayColor) {
          this.color = displayColor ? hasTicket ? 'green' : 'red' : 'blue';
        }
      });
    })();
  </script>
</dom-module>
