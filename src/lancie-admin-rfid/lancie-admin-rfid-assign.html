<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/lancie-ajax/lancie-ajax.html">

<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../lancie-admin-endpoint/lancie-admin-page-layout.html">

<dom-module id="lancie-admin-rfid-assign">
  <template>
    <style>
      :host {
        display: block;
      }

      .container {
        display: flex;
        justify-content: space-between;
      }

      .result {
        width: 200px;
        height: 200px;
        border-radius: 25px;
        box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        transition: background-color 0.5s ease;
      }

      .red {
        background-color: #F44336;
      }

      .blue {
        background-color: #2196F3;
      }

      .green {
        background-color: #4CAF50;
      }
    </style>

    <lancie-ajax
      auto
      id="allTicketsAjax"
      refurl="tickets"
      on-lancie-ajax="onTickets">
    </lancie-ajax>

    <lancie-ajax
      id="assignRfidAjax"
      refurl="rfid"
      method="post"
      body='{"rfid": "[[rfid]]", "ticketId": "[[ticketId]]"}'
      on-lancie-ajax="onAssignRfid">
    </lancie-ajax>

    <lancie-admin-page-layout endpoint="Assign RFID">
      <div class="container">
        <div>
          <p>Assign an RFID tag by selecting a user and scanning an RFID into the input below.</p>
          <paper-input autofocus id="rfid" value="{{rfid}}" on-keyDown="_requestTicket"></paper-input>
          <p>Search for a user below and select a user from the table.</p>
          <paper-input autofocus id="userSearch" value="{{filterString}}" on-keyDown="_requestTicket"></paper-input>
        </div>
        <div class$="result {{color}}"></div>
      </div>
      <paper-listbox selected="{{ticketId}}" attr-for-selected="data-id">
        <template is="dom-repeat" items='[[_filter(tickets, filterString)]]' as="ticket">
          <paper-item data-id="[[ticket.id]]">[[ticket.owner.username]]</paper-item>
        </template>
      </paper-listbox>
    </lancie-admin-page-layout>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        is: 'lancie-admin-rfid-assign',
        properties: {
          tickets: Array,
          rfid: String,
          assignSuccessful: {
            type: Boolean,
            value: false,
          },
          displayColor: {
            type: Boolean,
            value: false,
          },
          color: {
            type: String,
            value: 'blue',
          },
        },

        observers: [
          'computeColor(overage, underage)',
        ],

        _requestTicket: function (e) {
          if (e.keyCode === 13) {
            this.$.assignRfidAjax.generateRequest();
            this.rfid = '';
          }
          console.log(ticketId);
        },

        onTickets: function (e, request) {
          if (request.succeeded) {
            this.tickets = request.response;
          } else {
            this.fire('toast', {text: 'Could not retrieve users.'});
          }
        },

        onAssignRfid: function(e, request) {
          if (request.succeeded) {
            this.assignSuccessful = true;
          } else {
            this.fire('toast', {text: 'Could not assign RFID.'});
          }
          this.displayColor = true;
        },

        computeColor: function (overage, underage) {
          if (!overage && !underage) {
            this.color = 'blue';
          }
          if (overage && !underage) {
            this.color = 'green';
          }
          if (!overage && underage) {
            this.color = 'red';
          }
        },

        _filter: function(data, filterString) {
          if (!filterString) return data;
          var result = data.filter(function(entry) {
            return this._check(entry, filterString.toLowerCase())
          }.bind(this));
          return result;
        },

        _check: function(object, filterString) {
          for (var item in object) {
            if (!object[item]) continue;
            if (typeof object[item] === 'object' && this._check(object[item], filterString)) {
              return true;
            } else if (object[item].toString().toLowerCase().indexOf(filterString) !== -1) {
              return true;
            }
          }
          return false;
        },

      });
    })();
  </script>
</dom-module>
