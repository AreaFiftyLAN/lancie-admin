<link rel="import" href="../../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/lancie-ajax/lancie-ajax.html">

<link rel="import" href="../../lancie-admin-page-layout.html">
<link rel="import" href="../../../lancie-admin-table/lancie-admin-table.html">

<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/lancie-ajax/lancie-ajax.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../../../../bower_components/lancie-dialog/lancie-dialog.html">
<link rel="import" href="lancie-admin-seat.html">
<link rel="import" href="../../../../src/lancie-admin-icons.html">

<dom-module id="lancie-admin-seats">
  <template>
    <style>
      :host {
        display: block;
        padding: 32px;
      }

      @media(max-width: 600px) {
        :host {
          padding: 8px;
        }
      }

      [hidden] {
        display: none !important;
      }

      .seatmap-row {
        padding: 16px;
      }

      .seatmap-row .seats-group {
        width: 100px;
        display: flex;
        flex-wrap: wrap;
      }

      .add-seat {
        text-align: center;
        width: 100px;
        color: var(--secondary-color);
        font-size: 32px;
        font-weight: bold;
        background: var(--primary-color);
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
          0 1px 5px 0 rgba(0, 0, 0, 0.12),
          0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .seatmap {
        overflow: auto;
      }

      .seatmapwrapper {
        display: flex;
        justify-content: space-around;
      }

      .grouplabel {
        text-align: center;
        width: 100%;
        color: var(--secondary-color);
        font-size: 32px;
        font-weight: bold;
        background: var(--primary-color);
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
          0 1px 5px 0 rgba(0, 0, 0, 0.12),
          0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      .non-seat-group {
        min-width: 810px;
        margin-top: 60px;
        display: flex;
      }

      .non-seat-group>div {
        background-color: var(--paper-grey-500);
        display: inline-block;
        text-align: center;
      }

      .non-seat-group>div>div {
        position: relative;
        color: #fff;
        width: 100%;
        top: calc(50% - 0.75em);
      }

      .non-seat-group iron-icon {
        --iron-icon-height: 56px;
        --iron-icon-width: 56px;
      }

      .lounge {
        width: 300px;
        height: 450px;
      }

      .stage {
        width: 315px;
        height: 180px;
        margin-top: 270px;
      }

      .entrance {
        width: 195px;
        height: 330px;
        margin-top: 120px;
      }

      #listbox {
        overflow-y: auto;
        max-height: 40vh;
      }

      .seats {
        display: flex;
      }

      .team-member {
        cursor: pointer;
      }
    </style>

    <lancie-ajax auto-fire id="ajaxGetAllSeats" refurl="seats" on-lancie-ajax="onGetAllSeats"></lancie-ajax>
    <lancie-ajax auto-fire id="ajaxGetTeamTickets" refurl="tickets/teammembers" on-lancie-ajax="onGetTeamTickets"></lancie-ajax>
    <lancie-ajax id="ajaxReserveSeat" method="POST" on-lancie-ajax="onReserveSeat"></lancie-ajax>
    <lancie-ajax id="ajaxAddSeatRow" method="POST" body="[[getSeatGroupDTOBody(seatGroup,seatAmount)]]" on-lancie-ajax="onAddSeatRow" refurl = "seats"></lancie-ajax>
    <lancie-ajax id="ajaxRemoveSeats" method="DELETE" body="[[getSeatGroupDTOBody(removeGroup,removeAmount)]]" on-lancie-ajax="onRemoveSeats" refurl = "seats"></lancie-ajax>
    <lancie-ajax id="ajaxLockSeat" method="POST" body="[[lockBoolean]]" on-lancie-ajax="onLockSeat"></lancie-ajax>
    <lancie-ajax id="ajaxLockGroup" method="POST" body="[[lockBoolean]]" on-lancie-ajax="onLockGroup"></lancie-ajax>

    <paper-input label="Search user" value="{{filterUser}}"></paper-input>
    <div class="seatmapwrapper">
      <div class="seatmap">
        <div class="seats">
          <template is="dom-repeat" items='[[seatGroups]]'>
            <div class="seatmap-row">
              <div class="grouplabel" on-tap="openLockGroupDialog" data-item$="[[item]]">[[item]]</div>
              <div class="seats-group">
                <template is="dom-repeat" items="[[_getSeatGroup(seats, item)]]">
                  <lancie-admin-seat tickets="[[tickets]]" filter="[[filterUser]]" seat="[[item]]" user="[[user]]" fixed="[[fixed]]"></lancie-admin-seat>
                </template>
              </div>
            </div>
          </template>
          <div class="seatmap-row">
            <div class="add-seat" on-tap="openAddSeatRowDialog">+</div>
            <div class="add-seat" style="margin-top: 10px;" on-tap="openSeatRemoveDialog">-</div>
          </div>
        </div>
      </div>
    </div>

    <lancie-dialog id="seatDialog">
      <h2>Seat reservation</h2>
      <div class="dialog-content">
        <lancie-error id="error"></lancie-error>
        <div hidden$="[[_checkSeatTaken(seatToEdit)]]">
          <h4>Seat currently taken by:</h4>
          <p>[[seatToEdit.ticket.owner.profile.displayName]]</p>
          
        </div>
        <div hidden$="[[!_checkSeatTaken(seatToEdit)]]">
          <p>Seat is still available</p>
        </div>
      </div>
      <div class="dialog-actions">
        <paper-button on-tap="lockSeat">Toggle lock</paper-button>
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
    </lancie-dialog>

    <lancie-dialog id=seatRowDialog>
        <h2>Add a row of seats</h2>
        <div class="dialog-content">
          <lancie-error id="error2"></lancie-error>
          <paper-input label="Group Name" value="{{seatGroup}}"></paper-input>
          <paper-input label="Amount of seats" value="{{seatAmount}}"></paper-input>
          <paper-button on-tap="addSeatRow">Add seats</paper-button>
          <paper-button dialog-dismiss>Close</paper-button>
        </div>
    </lancie-dialog>

    <lancie-dialog id=lockGroupDialog>
      <h2>Lock/unlock Group</h2>
      <div class="dialog-content">
        <h4>Changing lock status of following group:</h4>
        <p>[[groupToLock]]</p>
        <paper-button on-tap="lockGroup">Lock seats</paper-button>
        <paper-button on-tap="unlockGroup">Unlock seats</paper-button>
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
  </lancie-dialog>

    <lancie-dialog id=seatRemoveDialog>
      <h2>Remove seats from a row</h2>
      <div class="dialog-content">
        <lancie-error id="removeError"></lancie-error>
        <paper-input label="Group Name" value="{{removeGroup}}"></paper-input>
        <paper-input label="Amount of seats" value={{removeAmount}}></paper-input>
        <paper-button on-tap="openSeatRemoveConfirmDialog">Remove seats</paper-button>
        <paper-button dialog-dismiss>Close</paper-button>
      </div>
    </lancie-dialog>

    <lancie-dialog id="seatRemoveDialogConfirm">
      <h2>Confirm deletion</h2>
      <div class="dialog-content">
        <h4>Are you certain you want to delete [[removeAmount]] seat(s) from the following row?</h4>
        <p>[[removeGroup]]</p>
      </div>
      <div class="dialog-actions">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button on-tap="removeSeats" class="confirm-delete-button">Remove</paper-button>
      </div>
    </lancie-dialog>
  </template>
  <script>
    (function () {
      'use strict';
      class LancieAdminSeats extends Polymer.Element {
        static get is() {
          return 'lancie-admin-seats';
        }

        static get properties() {
          return {
            user: Object,
            seats: {
              type: Array,
              value: () => [],
            },
            seatToReserve: Object,
            tickets: {
              type: Array,
              value: () => [],
            },
            fixed: {
              type: Boolean,
              notify: true
            },
            seatGroups: Array,
            seatGroup: Object,
            seatToEdit: Object
          };
        }

        ready() {
          super.ready();
          this.addEventListener('request-seat-edit', (e) => this.openSeatEditDialog(e));
        }

          refreshSeats() {
            this.dispatchEvent(new CustomEvent('toast', {
              detail: { text: 'Seat reservation succeeded!', duration: 3000 },
              bubbles: true,
              composed: true
            }));
            this.$.ajaxGetAllSeats.generateRequest();
          }

          onGetAllSeats(e, request) {
            if (!request.succeeded) {
              this.dispatchEvent(new CustomEvent('toast', {
                detail: { text: 'Something went wrong, please refresh the page!', duration: 8000 },
                bubbles: true,
                composed: true
              }));
              return;
            }
            const seatMap = request.response.seatmap;
            const groups = Object.keys(seatMap);
            this.set('seatGroups', groups);

            let seats = groups.map(x => seatMap[x]);
            for (let group of seats) {
              group.sort((a, b) => a.seatNumber - b.seatNumber);
            }

            this.seats = seats;
          }

          onGetTeamTickets(e, request) {
            if (!request.succeeded) {
              this.dispatchEvent(new CustomEvent('refreshToast', { bubbles: true, composed: true }));
              return;
            }
            this.set('tickets', request.response);
          }

          openAddSeatRowDialog() {
            this.$.error.clear();
            const lastGroupName = this.seatGroups[this.seatGroups.length-1];
            this.seatGroup = String.fromCharCode(lastGroupName.charCodeAt() + 1);
            this.$.seatRowDialog.open();
          }

          addSeatRow() {
            this.$.error2.clear();
            this.$.ajaxAddSeatRow.generateRequest();
          }

          getSeatGroupDTOBody(groupName, seatAmount) {
            return {
              "seatGroupName": groupName,
              "numberOfSeats": parseInt(seatAmount)
            };
          }

          onAddSeatRow(e, request) {
            this.$.seatRowDialog.close();
            this.$.ajaxGetAllSeats.generateRequest();
          }

          openSeatRemoveDialog() {
            this.$.removeError.clear();
            this.removeGroup = this.seatGroups[this.seatGroups.length-1];
            this.$.seatRemoveDialog.open();
          }

          openSeatRemoveConfirmDialog() {
            this.$.removeError.clear();
            if (!this.seatGroups.includes(this.removeGroup)) {
              this.$.removeError.setError("That Seat Group does not exist, choose a different one!");
              return;
            }
            this.$.seatRemoveDialogConfirm.open();
          }

          removeSeats() {
            this.$.seatRemoveDialogConfirm.close();
            this.$.ajaxRemoveSeats.generateRequest();
          }

          onRemoveSeats(e, request) {
            this.$.seatRemoveDialog.close();
            this.$.ajaxGetAllSeats.generateRequest();
          }

          lockSeat() {
            console.log("Locking seat")
            this.lockBoolean = !this.seatToEdit.locked;
            console.log(this.lockBoolean)
            const seat = this.seatToEdit;
            this.$.ajaxLockSeat.refurl = `seats/lock/${seat.seatGroup}/${seat.seatNumber}`;
            this.$.ajaxLockSeat.generateRequest();
          }

          onLockSeat(e, request) {
            console.log("Seat lock changed")
            this.$.ajaxGetAllSeats.generateRequest();
            this.$.seatDialog.close();
          }

          openLockGroupDialog(event) {
            console.log(event.target.dataset.item)
            this.groupToLock = event.target.dataset.item;
            this.$.lockGroupDialog.open();
          }

          lockGroup() {
            this.lockBoolean = true;
            this.$.ajaxLockGroup.refurl = `seats/lock/${this.groupToLock}`
            this.$.ajaxLockGroup.generateRequest();
          }

          unlockGroup() {
            this.lockBoolean = false;
            this.$.ajaxLockGroup.refurl = `seats/lock/${this.groupToLock}`
            this.$.ajaxLockGroup.generateRequest();
          }

          onLockGroup(e, request) {
            console.log("Seatgroup lock changed")
            this.$.ajaxGetAllSeats.generateRequest();
            this.$.lockGroupDialog.close();
          }

          reserveSeat() {
            this.$.error.clear();
            if (!this.$.listbox.selectedItem) {
              this.$.error.setError('Please select a user.');
              return;
            }
            const seat = this.seatToReserve;
            const ticket = this.$.listbox.selectedItem.dataset.ticket;
            this.$.ajaxReserveSeat.refurl = `seats/${seat.seatGroup}/${seat.seatNumber}/${ticket}`;
            this.$.ajaxReserveSeat.generateRequest();
          }

          onReserveSeat(e, request) {
            if (request.succeeded) {
              this.$.listbox.selected = undefined;
              this.refreshSeats();
              this.$.seatDialog.close();
            } else {
              if (request.request.status === 409) {
                this.$.error.setError('Seat is already taken.');
              } else {
                this.$.error.setError('Something went wrong, please refresh and try again.');
              }
            }
          }

          openSeatEditDialog(event) {
            this.seatToEdit = event.detail.seatToEdit;
            console.log(this.seatToEdit)
            this.$.error.clear();
            this.$.seatDialog.open();
          }

          _getSeatGroup(seats, group) {
            return seats[this.seatGroups.indexOf(group)];
          }

          _checkExists(tickets) {
            return tickets.filter(ticket => ticket.valid === true).length > 0;
          }

          _checkSeatTaken(seat) {
            return seat.ticket === null;
          }
      }

      customElements.define(LancieAdminSeats.is, LancieAdminSeats);
    })();
  </script>
</dom-module>