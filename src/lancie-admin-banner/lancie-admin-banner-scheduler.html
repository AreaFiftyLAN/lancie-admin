<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/lancie-ajax/lancie-ajax.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<!--Element that makes it possible to schedule banners by providing start- and enddates and a corresponding text for
the banner within that timeframe-->
<dom-module id="lancie-admin-banner-scheduler">
  <template>
    <style>
      :host {
        display: block;
      }

      .input-container {
        @apply --layout-horizontal;
      }

      paper-input {
        max-width: 200px;
        margin-right: 16px;
      }

      paper-textarea {
        width: 400px;
      }

      @media screen and (max-width: 420px) {
        paper-textarea {
          max-width: 350px;
        }
      }

      paper-button {
        margin-top: 16px;
        color: white;
      }

      paper-button.add {
        background-color: var(--paper-green-500);
      }

      paper-button.update {
        background-color: var(--lancie-button-color);
      }

      paper-button.delete {
        background-color: var(--paper-red-500);
      }

    </style>

    <lancie-ajax id="addBannerAjax" refurl="web/banners" method="POST" body="[[banner]]"
                 on-lancie-ajax="onAdd"></lancie-ajax>
    <lancie-ajax id="updateBannerAjax" refurl="web/banners/[[banner.id]]" method="POST" body="[[banner]]"
                 on-lancie-ajax="onAdd"></lancie-ajax>
    <lancie-ajax id="deleteBannerAjax" refurl="web/banners/[[banner.id]]" method="DELETE"
                 on-lancie-ajax="onDelete"></lancie-ajax>

    <div class="input-container">
      <paper-input id="startDate" label="Start date" name="start-date" type="date" placeholder="YYYY-MM-DD"
                   min="[[today]]"
                   value="{{banner.startDate}}"
                   error-message="The end date is before the start date"
                   required></paper-input>
      <paper-input id="endDate" label="End date" name="end-date" type="date" placeholder="YYYY-MM-DD"
                   min="[[today]]"
                   value="{{banner.endDate}}"
                   required></paper-input>
    </div>
    <paper-textarea value="{{banner.text}}"></paper-textarea>
    <paper-button hidden$="[[banner.id]]" raised class="add" on-tap="addBanner">add</paper-button>
    <paper-button hidden$="[[!banner.id]]" raised class="update" on-tap="updateBanner">update</paper-button>
    <paper-button raised class="delete" on-tap="deleteBanner">delete</paper-button>
  </template>

  <script>
    class LancieAdminBannerScheduler extends Polymer.Element {
      static get is() {
        return 'lancie-admin-banner-scheduler';
      }

      static get properties() {
        return {
          banner: Object,
          today: Date,
        };
      }

      constructor() {
        super();
        this.today = (new Date()).toISOString().slice(0, 10);
      }

      static get observers() {
        return ['_bannerChanged(banner.*)'];
      }

      _bannerChanged(banner) {
        const startDate = this.banner.startDate;
        const endDate = this.banner.endDate;
        this.$.startDate.invalid = endDate < startDate;
      }

      addBanner() {
        this.validateAndRequest(this.$.addBannerAjax.generateRequest);
      }

      updateBanner() {
        this.validateAndRequest(this.$.updateBannerAjax.generateRequest);
      }

      validateAndRequest(request) {
        if (!this.$.startDate.invalid)
          request();
        else
          this._fireToast('Make sure the dates are valid!');
      }

      deleteBanner() {
        if (this.banner.id)
          this.$.deleteBannerAjax.generateRequest();
        else {
          this.dispatchEvent(new CustomEvent('banner-removed', {
            bubbles: true, composed: true,
          }));
        }
      }

      // used for both an add and an update
      onAdd(e, req) {
        if (req.succeeded) {
          this.banner = req.response.object;
          this._fireToast(req.response.message);
        }
        this._fireToast("Request failed!");
      }

      onDelete(e, req) {
        if (req.succeeded) {
          this.banner = {};
          this.dispatchEvent(new CustomEvent('banner-removed', {
            bubbles: true, composed: true,
          }));
        }
        this._fireToast(req.response.message);
      }

      _fireToast(message) {
        this.dispatchEvent(new CustomEvent('toast', {
          bubbles: true, composed: true,
          detail: {text: message},
        }));
      }

    }

    customElements.define(LancieAdminBannerScheduler.is, LancieAdminBannerScheduler);
  </script>
</dom-module>
