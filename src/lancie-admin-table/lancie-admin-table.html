<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<dom-module id="lancie-admin-table">
  <template>
    <style>
      :host {
        display: block;
      }

      [hidden] {
        display: none !important;
      }

      vaadin-grid {
        --primary-color: var(--secondary-color);
        --vaadin-grid-row-stripe-cell: {
          background-color: #FBFBFB;
        }
      }
    </style>

    <paper-input value="{{filterString}}" type="search"></paper-input>

    <p id="noData" hidden>No data found!</p>

    <vaadin-grid id="grid"
      items="[[_filter(data, filterString)]]"
      hidden>
      <vaadin-grid-column width="50px" flex-grow="0">
        <template class="header">ID</template>
        <template>[[item.id]]</template>
      </vaadin-grid-column>
    </vaadin-grid>

  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'lancie-admin-table',
        properties: {
          data: Object,
          filterString: String,
          columnMappings: Object,
          columnRenderers: Object,
        },

        /*
          Sets that data after pre-processing data that is not
          readily displayable.
          If any mappings exist from an object to one or more
          properties, these are resolved and added in the columns,
          For more extensible processing of data, renderers can be
          used for a column. The renderer is able to attach custom
          HTML to the cell.
        */
        setData: function(data) {
          if (data.length) {
            // Get columns
            var keys = Object.keys(data[0]);
            var columns = keys.map(function(key) {
              // If a mapping exists, resolve it
              if (!!this.columnMappings[key]) {
                return this.columnMappings[key].map(function(item) {
                  return {
                    name: key + '.' + item,
                  };
                });
              }
              return {
                name: key,
              };
            }.bind(this));

            // Flatten the columns
            columns = [].concat.apply([], columns);

            /*
              Make all columns sortable, hidable and resizable.
              If there is a renderer for a column, the renderer is
              attached here.
            */
            columns = columns.map(function(col) {
              if (!!this.columnRenderers[col.name]) {
                col.renderer = this.columnRenderers[col.name];
              }
              col.sortable = true;
              col.hidable = true;
              col.resizable = true;
              return col;
            }.bind(this));

            // Flatten the columns and assign data
            for (var col in columns) {
              this._addColumn(columns[col].name);
            }
            this.data = data;
            this.$.grid.hidden = false;
          } else {
            this.$.noData.hidden = false;
          }
        },

        _addColumn: function(name) {
          var headerTemplate = document.createElement('template');
          headerTemplate.content.textContent = name;

          var bodyTemplate = document.createElement('template');
          bodyTemplate.content.textContent = '[[item.' + name +']]'

          var column = document.createElement('vaadin-grid-column');
					column.headerTemplate = headerTemplate;
          column.template = bodyTemplate;

          Polymer.dom(this.$.grid).appendChild(column);
        },

        _filter: function(data, filterString) {
          if (!filterString) return data;
          var result = data.filter(function(entry) {
            return this._check(entry, filterString.toLowerCase())
          }.bind(this));
          return result;
        },

        _check: function(object, filterString) {
          for (var item in object) {
            if (!object[item]) continue;
            if (typeof object[item] === 'object' && this._check(object[item], filterString)) {
              return true;
            } else if (object[item].toString().toLowerCase().indexOf(filterString) !== -1) {
              return true;
            }
          }
          return false;
        }
      });
    })();
  </script>
</dom-module>
